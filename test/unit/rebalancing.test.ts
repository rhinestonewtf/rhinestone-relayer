import { describe, it, expect, chai } from 'vitest'
import { AccrossRepaymentsRelayerContext, RelayRepaymentsRelayerContext, replaceRepaymentDestinations } from '../../src/helpers/rebalancing.ts'

const fillRouteCall = `0xdf2c9057000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000c200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000a4b1000000000000000000000000e59aaf21c4d9cf92d9ed4537f4404ba031f83b2300000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000004bc9280836c4e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec671688f0b900000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000eb0000000000000000000000000000000000000000000000000000000000000404b63e800d0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000075798463024bda64d83c94a64bc7d7eab41300ef00000000000000000000000000000000000000000000000000000000000001400000000000000000000000007579f2ad53b01c3d8779fe17928e0d48885b00030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000cd0f89b4fc6c3debaae89208554c4aed9101f81f000000000000000000000000000000000000000000000000000000000000028447cbbdca0000000000000000000000007579f2ad53b01c3d8779fe17928e0d48885b00030000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000e9e6e96bcaa3c113187cdb7e38aed9000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000cd0f89b4fc6c3debaae89208554c4aed9101f81f00000000000000000000000000000000005ad9ce1f5035fd62ca96cef16adaaf0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000052488003dd5000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003e0cabff530a78dfb2184131a7efc527131b144c3a35e6576c320707983452c5ec6000000000000000000000000000000000000000000000000000000000000a4b100000000000000000000000097918b6ff44eaccbd0e15ed7e195405e7361106200000000000000000000000097918b6ff44eaccbd0e15ed7e195405e73611062000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001a015f2c96c4475211d8d2224aab65a711724a18d459171e4182ca880000000000000000000000000000000000082af49447d8a07e3bd95bd0d56f35241523fbab100000000000000000000000000000000000000000000000000000000688ca99e0000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000160d3efd0fdef3b05df2e05f7af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000049eb5e000000000000000000000000000000000000000000000000000000000000000160d3efd0fdef3b05df2e05f7833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014103000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000689fa04f55471c0b5a16439ee8e26ba9b59f17b100000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006a6ddbf2d31498007fb2b1d2d48420b56d3e2ba4219b334690298eaacd2ed38bea2ca62300000000000000000000000000000000000000000000000000000000000000a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a47000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000550000000000e9e6e96bcaa3c113187cdb7e38aed90c7ef32551e7721615745cf1f57908a75f26c0544750b8783c46381f841c1d2e065dc37ee0026e6ba00354f263d1bcbd0fbe798471315a1ffb53149dafd298321c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041be34f69be24cdcc2c90cac398b0af65fb803be775c1657dbf2c48a380666a5bd5cce5d27ba12544b6497af488ddbb77c10606711343dad0e2fb1898ae1a9bbbd1b00000000000000000000000000000000000000000000000000000000000000`

const claimRouteCall = `0x0fbb12dc000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000a4b1000000000000000000000000e59aaf21c4d9cf92d9ed4537f4404ba031f83b2300000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000004bc9280836c4e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec671688f0b900000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000eb0000000000000000000000000000000000000000000000000000000000000404b63e800d0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000075798463024bda64d83c94a64bc7d7eab41300ef00000000000000000000000000000000000000000000000000000000000001400000000000000000000000007579f2ad53b01c3d8779fe17928e0d48885b00030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000cd0f89b4fc6c3debaae89208554c4aed9101f81f000000000000000000000000000000000000000000000000000000000000028447cbbdca0000000000000000000000007579f2ad53b01c3d8779fe17928e0d48885b00030000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000e9e6e96bcaa3c113187cdb7e38aed9000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000cd0f89b4fc6c3debaae89208554c4aed9101f81f00000000000000000000000000000000005ad9ce1f5035fd62ca96cef16adaaf0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000094404f9b89e000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088000000000000000000000000000000000000000000000000000000000000008a000000000000000000000000000000000000000000000000000000000000f424000000000000000000000000097918b6ff44eaccbd0e15ed7e195405e7361106200000000000000000000000097918b6ff44eaccbd0e15ed7e195405e7361106215f2c96c4475211d8d2224aab65a711724a18d459171e4182ca8800000000000000000000000000000000000000000000000000000000000000000006a6ddbf200000000000000000000000000000000000000000000000000000000688ca99e000000000000000000000000000000000000000000000000000000000000a4b10000000000000000000000000000000000000000000000000000000000002105000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000000000000000000000000000000000000000160d3efd0fdef3b05df2e05f7af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000049eb5e000000000000000000000000000000000000000000000000000000000000000160d3efd0fdef3b05df2e05f7833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000281030000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000abd3388a633758d0bae01efb885ef1e87bd519a6000000000000000000000000000000000000000000000000000000000049eb5e00000000000000000000000000000000000000000000000000000000000000000000000000000000abd3388a633758d0bae01efb885ef1e87bd519a60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000848fa31b58000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583160d3efd0fdef3b05df2e05f70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000049eb5e00000000000000000000000097918b6ff44eaccbd0e15ed7e195405e7361106200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014103000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000689fa04f55471c0b5a16439ee8e26ba9b59f17b100000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000550000000000e9e6e96bcaa3c113187cdb7e38aed90c7ef32551e7721615745cf1f57908a75f26c0544750b8783c46381f841c1d2e065dc37ee0026e6ba00354f263d1bcbd0fbe798471315a1ffb53149dafd298321c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000415fe6f9027d681f947a8e1bc95108ae869753cbe78e139a77fbe27dc2b8300a59763f897fe135013f870fdef7da0531aec259e05ce36902a0a65b9583dbff9eda1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`

describe('Rebalancing', () => {
    it('should replace repayment address and chain with given info for fill', () => {

        const updated = replaceRepaymentDestinations(fillRouteCall, { address: '0xdead00000000000000000000000000000000beef', chain: 123 })
    })

    it('should replace repayment address and chain with given info for claim', () => {

        const updated = replaceRepaymentDestinations(claimRouteCall, { address: '0xdead00000000000000000000000000000000beef', chain: 123 })
    })
})

describe('Accross repayments', () => {
    it('should correctly replace repayment address', () => {
        // extracted and taken from the fillRouteCall above
        const data = '0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000a4b1000000000000000000000000e59aaf21c4d9cf92d9ed4537f4404ba031f83b23'

        const rewritten = AccrossRepaymentsRelayerContext(data, {
            address: '0xdead00000000000000000000000000000000beef',
            chain: 123,
        })

        expect(rewritten).toEqual('0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000007b000000000000000000000000dead00000000000000000000000000000000beef')
    })

})